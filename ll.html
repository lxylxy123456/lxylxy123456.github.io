<!DOCTYPE html>
<!--
	This program records a device's location with human-readable lines
	Normally the file should be hosted in https://vps.hcc.io/l.html
	Copyright (C) 2020-2021  Eric Li 李宵逸

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as
	published by the Free Software Foundation, either version 3 of the
	License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Affero General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.0;
                                 maximum-scale=1.0; user-scalable=no">
  <title>LocationTrackerWeb</title>
  <style>
	* {
		box-sizing: border-box;
	}
	html, body {
		height: 100%;
	}
	body {
		margin: 0px;
		padding: 8px;
		overflow: hidden;	/* disable scroll */
	}
	body.flex {
		display: flex;
		flex-direction: column;
	}
	div.page {
		flex-grow: 1;
		display: flex;
		flex-direction: column;
	}
	.row {
		display: flex;
		flex-direction: row;
		
	}
	.col-2 {
		flex-grow: 1;
		float: left;
		overflow: hidden;
	}
	.col-4 {
		flex-grow: 2;
		float: left;
		overflow: hidden;
	}
	textarea {
		width: 100%;
		flex-grow: 1;
		white-space: pre;
		overflow-wrap: normal;
		overflow-x: scroll;
	}
	.big {
		font-size: 1.5em;
	}
	.gray {
		color: gray;
	}
	span.border {
		border: 1px solid gray;
		/* white-space: nowrap; */
	}
  </style>
</head>
<body class="flex">

  <div id="upper_btns" class="row">
    <button class="col-2" onclick="watchLocation();">追踪</button>
    <button class="col-2" onclick="getLocation();">定时</button>
    <button class="col-2" onclick="toggleConfig();">设置</button>
    <button class="col-2" onclick="answer_scroll();">滚动</button>
    <button class="col-4" onclick="swap_info();">交换</button>
  </div>

  <div id="main_page" class="page">
    <div id="info_table">
      <div class="row big">
        <span class="col-4 border" id="lo">经度</span>
        <span class="col-4 border" id="la">纬度</span>
        <span class="col-4 border"><span id="al">高度</span> m</span>
      </div>
      <div class="row">
        <span class="col-4 border big"><span id="he">朝向</span> deg</span>
        <span class="col-2 border gray"><span id="ac">精确度</span> m</span>
        <span class="col-4 border big"><span id="sp">速度</span> m/s</span>
        <span class="col-2 border gray"><span id="aa">高度精确度</span> m</span>
      </div>
      <div class="row big">
        <span class="col-4 border"><span id="kts">速度节</span> kts</span>
        <span class="col-4 border"><span id="mph">速度迈</span> mph</span>
        <span class="col-4 border"><span id="kmh">速度千米时</span> km/h</span>
      </div>
    </div>

    <textarea id="answer2" autocomplete="off"></textarea>
    <textarea id="answer" autocomplete="off"></textarea>
  </div>

  <div id="config_page" class="page" style="display: none;">
    <div id="config_btns" class="row">
      <div class="col-2">
        <input type="checkbox" name="accurate" value="high" autocomplete="off"
               onclick="accurate_clicked(event);">
        <label for="accurate" onclick="accurate_clicked(event);">非精确</label>
      </div>
      <div class="col-2">
        <input id="local_save_chk" type="checkbox" name="local_save"
               autocomplete="off" onclick="local_save_clicked()">
        <label for="local_save" onclick="local_save_clicked()">
          禁用本地储存
        </label>
      </div>
      <button class="col-2" onclick="show_storage();">显示本地储存</button>
      <button class="col-2" onclick="clear_storage();">清除本地储存</button>
      <button class="col-2" onclick="clear_storage_text();">清除文本</button>
    </div>
    <textarea id="answer3" autocomplete="off"></textarea>
  </div>

  <div id="lower_btns" class="row"></div>

  <script type="text/javascript">
	// Initialize
	lower_btns.innerHTML = upper_btns.innerHTML;
	// Helper functions
	function gebi(id) {
		return document.getElementById(id)
	}
	function unit_convert(speed, multiplier) {
		if (speed === null) {
			return "null";
		} else {
			return Math.round(speed * multiplier * 10) / 10;
		}
	}
	function format_degree(raw_data) {
		// 123.101 -> "123°06'36''.6" (similar to "%02d°%02d'%02d''%.6f")
		let sgn = raw_data < 0 ? '-' : '';
		let rem = raw_data < 0 ? -raw_data : raw_data;
		let deg = Math.trunc(rem);
		rem = (rem - deg) * 60.0;
		let min = Math.trunc(rem);
		rem = (rem - min) * 60.0;
		let sec = Math.trunc(rem);
		rem = (rem - sec) * 1000000.0;
		let point = Math.trunc(rem);
		return (sgn + deg + '°' + min.toString().padStart(2, '0')
					+ "'" + sec.toString().padStart(2, '0')
					+ "''." + point.toString().padStart(6, '0'))
	}
	// Handle UI change functions
	let accurate = true;
	function accurate_clicked(event) {
		// alert(event.target);
		let checkboxs = document.getElementsByName("accurate");
		for (let i = 0; i < checkboxs.length; i++) {
			checkboxs[i].checked = accurate;
		}
		accurate = !accurate;
	}
	let local_save = true;
	function local_save_clicked() {
		gebi("local_save_chk").checked = local_save;
		local_save = !local_save;
	}
	function toggleConfig() {
		const config = gebi('config_page').style['display'] == 'none';
		const cv = config ? '' : 'none';
		const mv = config ? 'none' : '';
		gebi('config_page').style.setProperty('display', cv);
		gebi('main_page').style.setProperty('display', mv);
	}
	function answer_scroll() {
		if (answer2.scrollTop != 0) {
			answer2.scrollTop = 0;
		} else {
			answer2.scrollTop = answer2.scrollHeight;
		}
		if (answer3.scrollTop != 0) {
			answer3.scrollTop = 0;
		} else {
			answer3.scrollTop = answer3.scrollHeight;
		}
	}
	function swap_info() {
		answer2.value += answer.value;
		answer.value = '';
	}
	function clear_storage_text() {
		answer3.value = '';
	}
	// Handle local storage
	function store_local_data(t, s) {
		if (!local_save)
			return;
		try {
			window.localStorage.setItem('LocationTracker:' + t, s);
		} catch (error) {
			answer3.value += 'Error storing to local storage at ' + t + '\n';
		}
	}
	function show_storage() {
		let values = [];
		for (let i = 0; i < window.localStorage.length; i++) {
			const key = window.localStorage.key(i);
			if (key.startsWith('LocationTracker:')) {
				values[values.length] = window.localStorage.getItem(key);
			}
		}
		function cmp(first, second) {
			const f = parseInt(first.substr(2, first.indexOf(',') - 2));
			const s = parseInt(second.substr(2, second.indexOf(',') - 2));
			return f < s;
		}
		values.sort(cmp);
		for (let i = 0; i < values.length; i++) {
			answer3.value += values[i];
		}
	}
	function clear_storage() {
		if (confirm('Are you sure to clear local storage?')) {
			// window.localStorage.clear();
			let keys = [];
			for (let i = 0; i < window.localStorage.length; i++) {
				const key = window.localStorage.key(i);
				if (key.startsWith('LocationTracker:')) {
					keys[keys.length] = key;
				}
			}
			for (let i = 0; i < keys.length; i++) {
				window.localStorage.removeItem(keys[i]);
			}
		}
	}
	// Fetch and display location data
	let watchLocation_confirm = false;
	function showPosition(position) {
		let a = position.coords;
		let params = [
				// simp_name, data, display_accuracy
				['la', a.latitude, 0],
				['lo', a.longitude, 0],
				['al', a.altitude, 1000],
				['ac', a.accuracy, 1000],
				['aa', a.altitudeAccuracy, 1000],
				['he', a.heading, 1000],
				['sp', a.speed, 10]
			];
		const t = Date.now().toString();
		let app = 't:' + t; 	// appending string
		for (let i = 0; i < params.length; i += 1) {
			let str = 'null';
			let display_str = 'null';
			if (!isNaN(params[i][1]) && params[i][1] != null) {
				str = params[i][1].toString();
				if (params[i][2] != 0) {
					display_str = (
						Math.round(params[i][1] * params[i][2]) / params[i][2]);
				} else {
					display_str = str;
				}
			}
			app += ',' + params[i][0] + ':' + str;
			// Display data in info_table
			gebi(params[i][0]).innerText = display_str;
		}
		app += '\n';
		answer.value += app;
		// Save data to localStorage
		store_local_data(t, app);
		// Display special data format in info_table
		gebi('kts').innerText = unit_convert(a.speed, 1.94384449);
		gebi('mph').innerText = unit_convert(a.speed, 2.23693629);
		gebi('kmh').innerText = unit_convert(a.speed, 3.6);
		gebi('la').innerText = format_degree(a.latitude);
		gebi('lo').innerText = format_degree(a.longitude);
	}
	function exit_refrain() {
		window.onbeforeunload = function () {
			return "Are you sure to close the window?";
		};
	}
	function getPositionOptions() {
		// https://developer.mozilla.org/zh-CN/docs/Web/API/PositionOptions
		return { enableHighAccuracy: accurate };
	}
	function getLocation() {
		exit_refrain();
		if (navigator.geolocation && confirm('是否持续请求定位？')) {
			navigator.geolocation.getCurrentPosition(showPosition, showError,
													getPositionOptions());
			setInterval("navigator.geolocation.getCurrentPosition" +
						"(showPosition,showError,getPositionOptions());",
						30000);
		}
	}
	function watchLocation() {
		exit_refrain();
		if (watchLocation_confirm == false) {
			watchLocation_confirm = true;
		} else {
			confirm('是否再次请求追踪？');
		}
		if (navigator.geolocation)
			navigator.geolocation.watchPosition(showPosition, showError,
												getPositionOptions());
	}
	function showError(error) {
		return; 	// Function disabled
		switch(error.code) {
			case error.PERMISSION_DENIED:
				alert('PERMISSION_DENIED');		break;
			case error.POSITION_UNAVAILABLE:
				alert('POSITION_UNAVAILABLE');	break;
			case error.TIMEOUT:
				alert('TIMEOUT');				break;
			case error.UNKNOWN_ERROR:
				alert('UNKNOWN_ERROR');			break;
		}
	}
  </script>
</body>

